

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DeBeKa ‚Äì QR-Flow (Umfrage ‚Üí Q&A ‚Üí Erkl√§rungen) + Admin-√úbersicht</title>
  <style>
    :root{
      --debeka-blue:#1e9ad6;
      --debeka-blue-soft:rgba(30,154,214,.18);
      --bg:#07101a;
      --text:#eaf3ff;
      --muted:#b8c9e6;
      --line:rgba(255,255,255,.12);
      --shadow:0 16px 50px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --max:1100px;
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1100px 650px at 12% -10%, var(--debeka-blue-soft), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(30,154,214,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    .wrap{max-width:var(--max); margin:0 auto; padding:28px 18px 60px;}
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; padding:18px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(11,23,38,.92), rgba(10,20,34,.78));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:sticky; top:14px;
      backdrop-filter: blur(10px);
      z-index:10;
    }
    @media (max-width: 860px){ header{position:relative; top:auto} }
    .brand{display:flex; align-items:center; gap:12px;}
    .brand h1{font-size:15px; margin:0; letter-spacing:.2px}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .logoImg{height:44px; width:auto; display:block; filter: drop-shadow(0 10px 24px rgba(30,154,214,.18));}

    nav{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .tabbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition:.18s ease;
    }
    .tabbtn:hover{transform: translateY(-1px); background:rgba(255,255,255,.06)}
    .tabbtn[aria-selected="true"]{
      background:linear-gradient(135deg, rgba(30,154,214,.20), rgba(255,255,255,.04));
      border-color:rgba(30,154,214,.55);
    }
    .tabbtn:disabled{opacity:.45; cursor:not-allowed}

    .hero{
      margin-top:18px;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 860px){ .hero{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(11,23,38,.82), rgba(10,20,34,.74));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .inner{padding:18px;}
    .card h2{margin:0 0 8px; font-size:20px; letter-spacing:.2px}
    .card p{margin:0 0 12px; color:var(--muted)}

    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px}
    .chip{
      font-size:12px; color:var(--text);
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      user-select:none;
    }

    .aside{display:flex; flex-direction:column; gap:12px; height:100%;}
    .mini{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(255,255,255,.03);
      padding:14px;
    }
    .mini h3{margin:0 0 8px; font-size:14px}
    .mini p{margin:0; color:var(--muted); font-size:13px}
    .note{
      margin-top:10px;
      font-size:12px;
      color:rgba(234,243,255,.90);
      border-left:3px solid rgba(30,154,214,.75);
      padding-left:10px;
      word-break:break-word;
    }

    main{margin-top:16px}
    .section{display:none; animation: fade .18s ease;}
    .section.active{display:block}
    @keyframes fade{from{opacity:.6; transform: translateY(4px)} to{opacity:1; transform: translateY(0)}}

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px;}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }

    .formRow{display:flex; gap:10px; flex-wrap:wrap}
    label{display:block; font-weight:750; font-size:13px; margin-bottom:6px}
    .field{
      flex:1;
      min-width: 220px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:var(--radius2);
      padding:12px;
      outline:none;
      transition:.15s ease;
    }
    .field:focus{border-color:rgba(30,154,214,.65); box-shadow:0 0 0 4px rgba(30,154,214,.18)}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}

    .q{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      padding:14px;
      margin-bottom:12px;
    }
    .qhead{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; margin-bottom:10px;}
    .qtitle{margin:0; font-size:14px; font-weight:800}
    .qtag{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(30,154,214,.12);
      white-space:nowrap;
    }
    .options{display:grid; gap:8px}
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid rgb(255, 255, 255);
      background:rgba(0,0,0,.12);
      padding:10px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s ease;
    }
    .opt:hover{border-color:rgba(255,255,255,.14); transform: translateY(-1px)}
    .opt input{margin-top:2px}
    .opt span{font-size:13px}
    .opt small{display:block; margin-top:2px; color:var(--muted); font-size:12px}

    textarea.field{min-height:96px; resize:vertical}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; align-items:center}
    .btn{
      border:1px solid rgba(30,154,214,.60);
      background:linear-gradient(135deg, rgba(30,154,214,.24), rgba(255,255,255,.04));
      color:var(--text);
      padding:11px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:850;
      font-size:13px;
      transition:.15s ease;
      text-decoration:none;
      display:inline-block;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.secondary{
      border-color:rgba(255,255,255,.18);
      background:rgba(255,255,255,.04);
      font-weight:700;
    }
    .btn.danger{
      border-color: rgba(255,107,107,.5);
      background: rgba(255,107,107,.12);
    }

    .status{margin-top:8px; font-size:13px; color:rgba(234,243,255,.9);}

    .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:12px;}
    @media (max-width: 860px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      padding:14px;
    }
    .kpi .box strong{display:block; font-size:18px}
    .kpi .box span{color:var(--muted); font-size:12px}

    details{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius);
      padding:12px;
      margin-bottom:10px;
    }
    summary{cursor:pointer; list-style:none; font-weight:850; font-size:14px; outline:none;}
    summary::-webkit-details-marker{display:none}
    .faqMeta{margin-top:6px; font-size:12px; color:var(--muted)}
    .faqBody{margin-top:10px; color:rgba(234,243,255,.92); font-size:13px}

    .footer{margin-top:18px; color:rgba(234,243,255,.8); font-size:12px; text-align:center;}
    .badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(30,154,214,.55);
      background:rgba(30,154,214,.14);
      margin-left:6px;
      font-weight:750;
    }

    .toast{
      position:fixed; right:14px; bottom:14px;
      border:1px solid var(--line);
      background:rgba(11,23,38,.92);
      backdrop-filter: blur(10px);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      max-width:360px;
      display:none;
    }
    .toast.show{display:block; animation: pop .16s ease}
    @keyframes pop{from{opacity:.3; transform: translateY(6px)} to{opacity:1; transform: translateY(0)}}

    /* QR-mode visuals */
    .qrBanner{
      margin-top:14px;
      border:1px solid rgba(30,154,214,.35);
      background:rgba(30,154,214,.10);
      border-radius:14px;
      padding:10px 12px;
      color:rgba(234,243,255,.95);
      display:none;
    }
    .qrBanner strong{color:#fff}
    .qrOnly{display:none;}
    .adminOnly{display:block;}
    body.qr-mode .adminOnly{display:none !important;}
    body.qr-mode .qrOnly{display:block;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img class="logoImg" src="https://upload.wikimedia.org/wikipedia/commons/8/87/Debeka.svg" alt="Debeka Logo" />
        <div>
          <h1>Umfrage ‚Üí Q&A ‚Üí Erkl√§rungen</h1>
          <p class="adminOnly">Admin-√úbersicht (du siehst alles). QR-Nutzer sehen nur den Flow.</p>
        </div>
      </div>

      <nav aria-label="Navigation" class="adminOnly">
        <button class="tabbtn" data-tab="overview" aria-selected="true">√úbersicht</button>
        <button class="tabbtn" data-tab="survey" aria-selected="false">Umfrage</button>
        <button class="tabbtn" data-tab="qna" aria-selected="false" id="qnaTab" disabled>Q&A</button>
        <button class="tabbtn" data-tab="explain" aria-selected="false" id="explainTab" disabled>Erkl√§rungen</button>
        <button class="tabbtn" data-tab="results" aria-selected="false">Auswertung</button>
      </nav>

      <!-- QR progress (only in QR mode) -->
      <nav class="qrOnly" aria-label="QR Fortschritt" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <span class="chip" id="qrStepChip">Schritt 1/3: Umfrage</span>
      </nav>
    </header>

    <div class="qrBanner" id="qrBanner">
      <strong>Erst Umfrage, dann Q&A, dann Erkl√§rungen.</strong> 
    </div>

    <!-- ADMIN OVERVIEW -->
    <section class="hero adminOnly" id="adminHero">
      <div class="card">
        <div class="inner">
          <h2>Admin-√úbersicht</h2>
          <p>Du kannst alles sehen: Umfrage, Q&A-Logik, Erkl√§rungen und Auswertungen. QR-Nutzer sehen nur den gef√ºhrten Ablauf.</p>
          <div class="chips">
            <span class="chip">üîó QR-Link: <span id="qrLinkInline"></span></span>
            <span class="chip">üß© Platzhalter-Inhalte</span>
            <span class="chip">üìä Lokale Auswertung</span>
          </div>
        </div>
      </div>

      <div class="aside">
        <div class="mini">
          <h3>QR-Link (f√ºr Flyer)</h3>
          <p>Setze den QR-Code auf:</p>
          <div class="note" id="qrLinkBox">‚Äì</div>
          <p class="hint" style="margin-top:8px;">Wichtig: <strong>#qr</strong> aktiviert den gef√ºhrten Flow.</p>
        </div>

        <div class="mini">
          <h3>Reset (f√ºr Tests)</h3>
          <p>L√∂scht lokale Daten (nur dein Browser):</p>
          <div class="btnRow" style="margin-top:10px;">
            <button class="btn danger" type="button" id="resetAll">Lokale Daten l√∂schen</button>
          </div>
        </div>
      </div>
    </section>

    <main>
      <!-- √úBERSICHT (ADMIN) -->
      <section id="overview" class="section active adminOnly">
        <div class="grid">
          <div class="card">
            <div class="inner">
              <h2>Was QR-Nutzer sehen</h2>
              <p>Linearer Ablauf:</p>
              <div class="chips">
                <span class="chip">1) Umfrage</span>
                <span class="chip">2) Q&A</span>
                <span class="chip">3) Erkl√§rungen</span>
              </div>
              <div class="note" style="margin-top:12px;">
                Inhalte sind noch Platzhalter. Sp√§ter ersetzt ihr nur die Texte in <strong>QNA_LIBRARY</strong> und <strong>EXPLAIN_LIBRARY</strong>.
              </div>
              <div class="btnRow">
                <button class="btn secondary" type="button" id="adminJumpSurvey">Zur Umfrage</button>
                <button class="btn secondary" type="button" id="adminJumpResults">Zur Auswertung</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="inner">
              <h2>Live-Kurzauswertung (lokal)</h2>
              <div class="kpi">
                <div class="box"><strong id="kpiCount">0</strong><span>Antworten</span></div>
                <div class="box"><strong id="kpiTopBausparen">‚Äì</strong><span>Top: Bausparen</span></div>
                <div class="box"><strong id="kpiTopInsurance">‚Äì</strong><span>Top: Versicherung</span></div>
              </div>
              <div class="hint" style="margin-top:10px;">Nur zur Vorschau (sp√§ter Backend m√∂glich).</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 1) UMFRAGE -->
      <section id="survey" class="section">
        <div class="grid">
          <div class="card">
            <div class="inner">
              <h2>Umfrage</h2>
              <p>Nach dem Absenden geht es automatisch weiter zum Q&A.</p>

              <form id="surveyForm" novalidate>
                <div class="formRow">
                  <div style="flex:1; min-width:220px;">
                    <label for="ageGroup">Altersgruppe</label>
                    <select class="field" id="ageGroup" name="ageGroup" required>
                      <option value="" selected disabled>Bitte w√§hlen‚Ä¶</option>
                      <option value="18-20">18‚Äì20</option>
                      <option value="21-23">21-23</option>
                      <option value="24-26">24-26</option>
                      <option value="27+">27+</option>
                    </select>
                  </div>

                  <div style="flex:1; min-width:220px;">
                    <label for="status">Aktueller Status</label>
                    <select class="field" id="status" name="status" required>
                      <option value="" selected disabled>Bitte w√§hlen‚Ä¶</option>
                      <option value="student">Student/in</option>
                      <option value="azubi">Ausbildung</option>
                      <option value="jobstart">Berufseinstieg (0‚Äì2 Jahre)</option>
                      <option value="youngpro">Young Professional</option>
                      <option value="other">Sonstiges</option>
                    </select>
                  </div>

                  <div style="flex:1; min-width:220px;">
                    <label for="source">Wie bist du auf die Umfrage gekommen?</label>
                    <select class="field" id="source" name="source" required>
                      <option value="" selected disabled>Bitte w√§hlen‚Ä¶</option>
                      <option value="flyer">Flyer</option>
                      <option value="qr">Direkter QR-Code</option>
                    
                    </select>
                  </div>
                </div>

                <div class="q">
                  <div class="qhead">
                    <p class="qtitle">1) Wie wichtig ist dir aktuell der Aufbau von Verm√∂gen f√ºr deine Zukunft?</p>

                  </div>
                  <div class="options">
                    <label class="opt"><input type="radio" name="goal" value="ruecklagen" required>
                      <span>Sehr wichtig ‚Äì ich spare regelm√§√üig</span>
                    </label>
                    <label class="opt"><input type="radio" name="goal" value="wohnen">
                      <span>Wichtig ‚Äì aber ich habe noch keinen festen Plan</span>
                    </label>
                    <label class="opt"><input type="radio" name="goal" value="vorsorge">
                      <span>Noch nicht so wichtig</span>
                    </label>
                  </div>
                </div>

                <div class="q">
                  <div class="qhead">
                    <p class="qtitle">2) Wei√üt du, was ein Bausparvertrag ist und welche Vorteile er beim sp√§teren Wohnen haben kann?</p>
                  </div>
                  <div class="options">
                    <label class="opt"><input type="radio" name="bausparen_interest" value="unsicher">
                      <span>Ja, kenne ich gut</span>
                    </label>
                    <label class="opt"><input type="radio" name="bausparen_interest" value="sehr" required>
                      <span>Schon mal geh√∂rt</span>
                    </label>
                    <label class="opt"><input type="radio" name="bausparen_interest" value="eher">
                      <span>Nein, noch nicht</span>
                    </label>
                  </div>
                </div>

                <div class="q">
                  <div class="qhead">
                    <p class="qtitle">3) Nutzt du bereits verm√∂genswirksame Leistungen oder staatliche F√∂rderungen (z. B. Wohnungsbaupr√§mie)?</p>
                    
                  </div>
                  <div class="options">
                    <label class="opt"><input type="radio" name="bausparen_barrier" value="wissen" required>
                      <span>Ja</span>
                    </label>
                    <label class="opt"><input type="radio" name="bausparen_barrier" value="budget">
                      <span>Nein, aber interessiert mich</span>
                    </label>
                    <label class="opt"><input type="radio" name="bausparen_barrier" value="lohnt">
                      <span>Nein, kenne ich nicht</span>
                    </label>
                  </div>
                </div>

                <div class="q">
                  <div class="qhead">
                    <p class="qtitle">4) Welche Versicherungen hast du aktuell?</p>
                    
                  </div>
                  <div class="options" id="insuranceOptions">
                    <label class="opt"><input type="radio" name="insurance_priorities" value="Mehrere">
                      <span>Mehrere wichtige (z. B. Haftpflicht etc.)</span>
                    </label>
                    <label class="opt"><input type="radio" name="insurance_priorities" value="wenig">
                      <span>Nur wenige</span>
                    </label>
                    <label class="opt"><input type="radio" name="insurance_priorities" value="keine" required>
                      <span>Noch keine / unsicher</span>
                    </label>
                  </div>
                  
                </div>

                <div class="q">
                  <div class="qhead">
                    <p class="qtitle">5) Hast du einen Plan, wie du deine finanzielle Zukunft (Wohnen, Absicherung, Sparen) gestalten m√∂chtest?</p>
                   
                  </div>
                  <div class="options">
                    <label class="opt"><input type="radio" name="contact_pref" value="kurz" required>
                      <span>Ja, klarer Plan</span>
                    </label>
                    <label class="opt"><input type="radio" name="contact_pref" value="vergleich">
                      <span>Teilweise</span>
                    </label>
                    <label class="opt"><input type="radio" name="contact_pref" value="beratung">
                      <span>Nein, brauche Orientierung</span>
                    </label>
                  </div>
                </div>

              

                <div class="btnRow">
                  <button type="submit" class="btn">Umfrage abschicken</button>
                  <button type="button" class="btn secondary adminOnly" id="fillDemo">Demo ausf√ºllen</button>
                </div>

                <div class="status" id="surveyStatus" role="status" aria-live="polite"></div>
              </form>
            </div>
          </div>

          <div class="card adminOnly">
            <div class="inner">
              <h2>Admin-Hinweis</h2>
              <p>Im QR-Modus ist die Navigation ausgeblendet. Hier (Admin) kannst du alles direkt anspringen.</p>
              <div class="note">QR-Link: <strong id="qrLinkRepeat"></strong></div>
            </div>
          </div>

          <div class="card qrOnly">
            <div class="inner">
              <h2>Schritt 1/3</h2>
              <p>Bitte f√ºlle die Umfrage aus. Danach bekommst du passende Fragen und Erkl√§rungen.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- 2) Q&A -->
      <section id="qna" class="section">
        <div class="grid">
          <div class="card">
            <div class="inner">
              <h2>Q&A</h2>
              <p id="profileLine" class="note" style="border-left-color:rgba(30,154,214,.75)">‚Äì</p>
              <div id="qnaList"></div>

              <div class="btnRow">
                <button class="btn" type="button" id="toExplain">Weiter zu Erkl√§rungen</button>
                <button class="btn secondary adminOnly" type="button" id="backToSurvey">Zur Umfrage</button>
              </div>
            </div>
          </div>

          <div class="card qrOnly">
            <div class="inner">
              <h2>Schritt 2/3</h2>
              <p>Hier sind oft gestellte Fragen.</p>
            </div>
          </div>

          <div class="card adminOnly">
            <div class="inner">
              <h2>Admin: Inhalte tauschen</h2>
              <p>Die Texte stehen in <strong>QNA_LIBRARY</strong>. Nur dort ersetzen ‚Äì Logik bleibt gleich.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- 3) ERKL√ÑRUNGEN -->
      <section id="explain" class="section">
        <div class="grid">
          <div class="card">
            <div class="inner">
              <h2>Erkl√§rungen & Ausf√ºhrungen</h2>
              <p>Hier findest du ausf√ºhrliche Erkl√§rungen zu den Themen</p>

              <div id="explainList"></div>

              <div class="btnRow">
                <button class="btn secondary adminOnly" type="button" id="backToQna">Zur√ºck zu Q&A</button>
                <button class="btn secondary adminOnly" type="button" id="toResults">Zur Auswertung</button>
                <button class="btn secondary qrOnly" type="button" id="qrRestart">Zur√ºck zum Start</button>
              </div>
            </div>
          </div>

          <div class="card qrOnly">
            <div class="inner">
              <h2>Schritt 3/3</h2>
              <p>Zum Schluss bekommst du Erkl√§rungen. Danach bist du fertig.</p>
            </div>
          </div>

          <div class="card adminOnly">
            <div class="inner">
              <h2>Admin: Inhalte tauschen</h2>
              <p>Die Texte stehen in <strong>EXPLAIN_LIBRARY</strong>. Nur dort ersetzen ‚Äì Logik bleibt gleich.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- AUSWERTUNG (ADMIN) -->
      <section id="results" class="section adminOnly">
        <div class="grid">
          <div class="card">
            <div class="inner">
              <h2>Auswertung (lokal)</h2>
              <div class="kpi">
                <div class="box"><strong id="rCount">0</strong><span>Antworten insgesamt</span></div>
                <div class="box"><strong id="rBausparen">‚Äì</strong><span>Top (Bausparen)</span></div>
                <div class="box"><strong id="rInsurance">‚Äì</strong><span>Top (Versicherung)</span></div>
              </div>

              <div style="margin-top:16px">
                <label for="exportBox">Export (JSON)</label>
                <textarea id="exportBox" class="field" readonly></textarea>
                <div class="btnRow">
                  <button class="btn secondary" type="button" id="copyJson">JSON kopieren</button>
                  <button class="btn secondary" type="button" id="downloadJson">JSON herunterladen</button>
                </div>
                <div class="status" id="exportStatus" role="status" aria-live="polite"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="inner">
              <h2>Admin-Navigation</h2>
              <div class="btnRow">
                <button class="btn secondary" type="button" id="adminToOverview">Zur √úbersicht</button>
                <button class="btn secondary" type="button" id="adminToSurvey">Zur Umfrage</button>
              </div>
              <div class="note">Diese Auswertung ist lokal (Browser). Sp√§ter k√∂nnt ihr das auf ein Backend umstellen.</div>
            </div>
          </div>
        </div>
      </section>

      <div class="footer">
        Private Demo ‚Ä¢ Stand: <span id="today"></span>
        <span class="badge">QR-Flow + Admin</span>
      </div>
    </main>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // -----------------------------
    // Storage keys (lokal)
    // -----------------------------
    const STORE_ANSWERS = "debeka_answers_v3";
    const STORE_LAST = "debeka_last_answer_v3";

    // -----------------------------
    // Q&A library (PLATZHALTER!)
    // -----------------------------
    

    // -----------------------------
    // EXPLAIN library (PLATZHALTER!)
    // -> "Erkl√§rungen & Ausf√ºhrungen" nach dem Q&A
    // -----------------------------
    const EXPLAIN_LIBRARY = {
      base: [
        {
          title: "[PLATZHALTER] Kurz-Guide: So triffst du Entscheidungen",
          body: "[PLATZHALTER] 1) Ziel kl√§ren  2) Budget pr√ºfen  3) Risiken priorisieren  4) Optionen vergleichen  5) Entscheidung dokumentieren."
        }
      ],
      byBarrier: {
        wissen: {
          title: "[PLATZHALTER] Begriffe einfach erkl√§rt",
          body: "[PLATZHALTER] Glossar: Sparphase, Zuteilung, Darlehen, Abschlusskosten, Effektivkosten‚Ä¶"
        },
        budget: {
          title: "[PLATZHALTER] Budget-Planung",
          body: "[PLATZHALTER] Beispiel: fixe/variable Kosten + Sparrate + Puffer. Was hei√üt ‚Äûflexibel‚Äú in der Praxis?"
        },
        lohnt: {
          title: "[PLATZHALTER] Lohnt es sich? ‚Äì Bewertungsraster",
          body: "[PLATZzPLATZHALTER] Faktoren: Geb√ºhren, Zinserwartung, Zeit, Planbarkeit, Alternativen."
        },
        flex: {
          title: "[PLATZHALTER] Flexibilit√§t & Laufzeit",
          body: "[PLATZHALTER] Welche Stellschrauben gibt es typischerweise (Sparrate pausieren/anpassen etc.)?"
        }
      },
      byInsurance: {
        haftpflicht: {
          title: "[PLATZHALTER] Haftpflicht ‚Äì typische F√§lle",
          body: "[PLATZHALTER] Beispiele aus Alltag/Studium + worauf bei Deckungssumme/Ausschl√ºssen achten."
        },
        bu: {
          title: "[PLATZHALTER] BU ‚Äì worum geht‚Äôs wirklich?",
          body: "[PLATZHALTER] Absicherung des Einkommens + wichtige Begriffe + wann Beratung sinnvoll ist."
        },
        reise: {
          title: "[PLATZHALTER] Auslandsreise-KV ‚Äì Checkliste",
          body: "[PLATZHALTER] Leistungen, Dauer, Ausschl√ºsse, Notfallnummer, Selbstbehalt‚Ä¶"
        }
      }
    };

    // -----------------------------
    // Helpers
    // -----------------------------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._timer);
      toast._timer = setTimeout(()=>t.classList.remove("show"), 2600);
    }

    function readAll(){
      try{ return JSON.parse(localStorage.getItem("debeka_answers_v3") || "[]"); } catch { return []; }
    }
    function writeAll(arr){
  localStorage.setItem(STORE_ANSWERS, JSON.stringify(arr));
  updateResultsUI();
  updateOverviewKpis();

  //  Cloud Sync (Firestore) ‚Äì speichert die komplette √úbersicht
  trySyncAllToCloud(arr);
}
async function trySyncAllToCloud(arr){
  try{
    // Nur wenn Firebase initialisiert ist
    if(!window.db || !window.firebaseAddDoc || !window.firebaseCollection) return;

    // Optional: nicht im Admin-Modus syncen (wenn du willst)
    // if(!(location.hash || "").toLowerCase().includes("qr")) return;

    await window.firebaseAddDoc(
      window.firebaseCollection(window.db, "responses"),
      {
        answersAll: arr,
        createdAt: window.firebaseServerTimestamp ? window.firebaseServerTimestamp() : new Date().toISOString(),
        page: location.href,
        ua: navigator.userAgent
      }
    );
    // optional: toast("Cloud gespeichert ‚úÖ");
  } catch(e){
    console.error("Cloud Sync (all) failed:", e);
    // optional: toast("Speichern fehlgeschlagen (Cloud).");
  }
}


    function getLastAnswer(){
      try{ return JSON.parse(localStorage.getItem(STORE_LAST) || "null"); }catch{ return null; }
    }
    function setLastAnswer(a){ localStorage.setItem(STORE_LAST, JSON.stringify(a)); }

    function freqTop(values){
      const map = new Map();
      values.forEach(v=>{
        if(v===undefined || v===null || v==="" ) return;
        if(Array.isArray(v)){ v.forEach(x => map.set(x, (map.get(x)||0)+1)); }
        else { map.set(v, (map.get(v)||0)+1); }
      });
      let best=null, bestN=0;
      for(const [k,n] of map.entries()){ if(n>bestN){ best=k; bestN=n; } }
      return best ? `${best} (${bestN})` : "‚Äì";
    }

    function safeDownload(filename, text){
      const blob = new Blob([text], {type:"application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 800);
    }

    // -----------------------------
    // Tabs / sections
    // -----------------------------
    const tabButtons = $$(".tabbtn");
    const sections = $$(".section");

    function showTab(name){
      sections.forEach(s => s.classList.toggle("active", s.id===name));
      tabButtons.forEach(b => b.setAttribute("aria-selected", String(b.dataset.tab===name)));
      window.scrollTo({top:0, behavior:"smooth"});
    }
    tabButtons.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(btn.disabled) return;
        showTab(btn.dataset.tab);
      });
    });

    // -----------------------------
    // QR mode detection
    // -----------------------------
    function isQRMode(){
      const params = new URLSearchParams(location.search);
      return location.hash.toLowerCase().includes("qr") || params.get("qr")==="1";
    }

    function setQRStep(step){
      const chip = $("#qrStepChip");
      if(!chip) return;
      const labels = {
        1: "Schritt 1/3: Umfrage",
        2: "Schritt 2/3: Q&A",
        3: "Schritt 3/3: Erkl√§rungen"
      };
      chip.textContent = labels[step] || "Schritt";
    }

    // -----------------------------
    // Survey: limit insurance to 2
    // -----------------------------
    const insWrap = $("#insuranceOptions");
    if(insWrap) insWrap.addEventListener("change", (e)=>{
      const checks = $$("input[type='checkbox'][name='insurance_priorities']", $("#insuranceOptions"));
      const picked = checks.filter(c=>c.checked);
      if(picked.length > 2){
        e.target.checked = false;
        toast("Maximal 2 ausw√§hlen üôÇ");
      }
    });

    // -----------------------------
    // Q&A generation
    // -----------------------------
    function buildProfileText(a){
      const ins = (a.insurance_priorities||[]).join(", ") || "‚Äì";
      const src = a.source ? ` ¬∑ Quelle: ${a.source}` : "";
      return `Bausparen: ${a.bausparen_interest || "‚Äì"} ¬∑ H√ºrde: ${a.bausparen_barrier || "‚Äì"} ¬∑ Versicherungen: ${ins}${src}`;
    }

    
    function pickQnaForAnswer(a){
  // IMMER die gleichen 4 Fragen anzeigen (unabh√§ngig von Antworten)
  return [
    {
      cat: "Bauchsparen",
      q: "Was ist ein Bausparvertrag und welchen Nutzen hat er?",
      a: "Ein Bausparvertrag kombiniert Sparen und Finanzierung in einem Produkt. Du sparst zun√§chst regelm√§√üig Geld an und sicherst dir dadurch sp√§ter ein zinsg√ºnstiges Darlehen f√ºr wohnwirtschaftliche Zwecke, z. B. Immobilienkauf, Renovierung oder Modernisierung. Der Nutzen liegt vor allem in planbaren Zinsen, langfristiger Sicherheit und m√∂glichen staatlichen F√∂rderungen. Besonders f√ºr junge Erwachsene kann er helfen, fr√ºhzeitig Eigenkapital aufzubauen und sich stabile Finanzierungskonditionen f√ºr die Zukunft zu sichern.."
    },
    {
      cat: "Staatliche F√∂rderung",
      q: "Welche staatlichen F√∂rderungen gibt es beim Verm√∂gensaufbau und wie funktionieren sie?",
      a: "Beim Verm√∂gensaufbau kannst du unter bestimmten Voraussetzungen staatliche F√∂rderungen nutzen, z. B. die Wohnungsbaupr√§mie oder die Arbeitnehmer-Sparzulage. Die Wohnungsbaupr√§mie unterst√ºtzt dich beim Sparen f√ºr wohnwirtschaftliche Zwecke wie einen Bausparvertrag und erh√∂ht deine Einzahlungen durch einen staatlichen Zuschuss. Die Arbeitnehmer-Sparzulage f√∂rdert verm√∂genswirksame Leistungen vom Arbeitgeber, wenn diese in geeignete Sparformen eingezahlt werden. Der Nutzen besteht darin, dass du zus√§tzliches Geld vom Staat erh√§ltst und dadurch schneller Verm√∂gen aufbauen kannst."
    },
    {
      cat: "Verm√∂genswirksame Leistungen",
      q: "Was sind verm√∂genswirksame Leistungen und wie kannst du davon profitieren?",
      a: "Verm√∂genswirksame Leistungen (VL) sind Geldbetr√§ge, die dein Arbeitgeber zus√§tzlich zu deinem Gehalt in einen Sparvertrag einzahlen kann. Diese k√∂nnen z. B. in einen Bausparvertrag, Fonds oder andere gef√∂rderte Sparformen flie√üen. Der Nutzen liegt darin, dass du mit Unterst√ºtzung deines Arbeitgebers Verm√∂gen aufbaust und unter bestimmten Voraussetzungen zus√§tzlich staatliche F√∂rderungen wie die Arbeitnehmer-Sparzulage erhalten kannst. Um VL zu bekommen, musst du deinen Arbeitgeber danach fragen und einen passenden Sparvertrag ausw√§hlen."
    },
    {
      cat: "Versicherungen",
      q: "Warum sind Versicherungen wichtig und welchen Nutzen haben sie?",
      a: "Versicherungen dienen dazu, finanzielle Risiken abzusichern und dich vor unerwarteten Kosten zu sch√ºtzen. Sie funktionieren nach dem Prinzip der Solidargemeinschaft: Viele zahlen Beitr√§ge ein, damit im Schadensfall einzelne finanziell unterst√ºtzt werden k√∂nnen. Der Nutzen besteht darin, dass gro√üe finanzielle Belastungen, z. B. durch Sch√§den, Unf√§lle oder Haftungsf√§lle, nicht allein getragen werden m√ºssen. Besonders grundlegende Versicherungen k√∂nnen helfen, deine finanzielle Sicherheit zu erh√∂hen und langfristige Planung zu erm√∂glichen, beispielsweise eine private Haftpflichtversicherung zum Schutz vor Schadensersatzforderungen oder eine Berufsunf√§higkeitsversicherung zur Absicherung deines Einkommens."
    },
    {
      cat: "Beratung",
      q: "Intersse geweckt?",
      a: "F√ºr einen Termin zur individuellen Beratung der Debeka erkundigen Sie sich unter: 0800 888008200",
    },
  ];
}


    function renderQna(a){
      $("#profileLine").textContent = buildProfileText(a);
      const items = pickQnaForAnswer(a);

      const root = $("#qnaList");
      root.innerHTML = "";
      items.forEach(item=>{
        const d = document.createElement("details");
        const s = document.createElement("summary");
        s.textContent = item.q;

        const meta = document.createElement("div");
        meta.className = "faqMeta";
        meta.textContent = `Kategorie: ${item.cat}`;

        const body = document.createElement("div");
        body.className = "faqBody";
        body.textContent = item.a;

        d.appendChild(s);
        d.appendChild(meta);
        d.appendChild(body);
        root.appendChild(d);
      });
    }

    function unlockNextTabs(){
      $("#qnaTab").disabled = false;
      $("#explainTab").disabled = false;
    }

    // -----------------------------
    // Explain generation
    // -----------------------------
    function renderExplain() {

  const root = document.getElementById("explainList");
  root.innerHTML = "";

  const fixedExplain = [

    {
      
      title: "Staatliche F√∂rderungen ‚Äì wie sie funktionieren und wie du sie nutzt",
      text: "Viele junge Erwachsene wissen nicht, dass der Staat aktiv beim Verm√∂gensaufbau unterst√ºtzt. Zu den wichtigsten F√∂rderungen geh√∂ren die Wohnungsbaupr√§mie und die Arbeitnehmer-Sparzulage. Die Wohnungsbaupr√§mie ist ein staatlicher Zuschuss, der gew√§hrt wird, wenn du regelm√§√üig Geld in einen geeigneten Sparvertrag, zum Beispiel einen Bausparvertrag, einzahlst. Ziel ist es, dich beim langfristigen Aufbau von Eigenkapital f√ºr wohnwirtschaftliche Zwecke zu unterst√ºtzen. Die Arbeitnehmer-Sparzulage hingegen f√∂rdert verm√∂genswirksame Leistungen (VL), also Geld, das dein Arbeitgeber zus√§tzlich zum Gehalt in einen Sparvertrag einzahlen kann. Damit du diese F√∂rderungen erh√§ltst, m√ºssen bestimmte Voraussetzungen erf√ºllt sein, wie beispielsweise Einkommensgrenzen oder die Nutzung eines zugelassenen Vertrags. Die Beantragung erfolgt meist nicht direkt √ºber einen separaten Antrag, sondern wird √ºber deine j√§hrliche Steuererkl√§rung oder automatisch √ºber den Anbieter abgewickelt. Gerade f√ºr junge Erwachsene lohnt sich ein genauer Blick auf diese F√∂rderungen, da sie eine M√∂glichkeit bieten, mit relativ kleinen eigenen Beitr√§gen und zus√§tzlicher Unterst√ºtzung durch Staat und Arbeitgeber langfristig Verm√∂gen aufzubauen."


    },

    {
      title: "Verm√∂genswirksame Leistungen ‚Äì wie sie funktionieren und wie du sie optimal nutzt",
      text: "Verm√∂genswirksame Leistungen (VL) sind ein zus√§tzlicher Geldbetrag, den dein Arbeitgeber freiwillig oder tariflich geregelt f√ºr dich sparen kann. Dieses Geld wird nicht direkt ausgezahlt, sondern in einen geeigneten Sparvertrag eingezahlt, zum Beispiel einen Bausparvertrag oder eine andere gef√∂rderte Anlageform. Ziel der VL ist es, Arbeitnehmer beim langfristigen Verm√∂gensaufbau zu unterst√ºtzen. Um VL zu erhalten, musst du zun√§chst pr√ºfen, ob dein Arbeitgeber diese anbietet und anschlie√üend einen passenden Vertrag ausw√§hlen, in den die Beitr√§ge eingezahlt werden k√∂nnen. H√§ufig ist daf√ºr ein einfacher Antrag beim Arbeitgeber notwendig. Unter bestimmten Voraussetzungen kannst du zus√§tzlich staatliche F√∂rderung in Form der Arbeitnehmer-Sparzulage erhalten, wenn dein Einkommen unter festgelegten Grenzen liegt. F√ºr junge Erwachsene sind VL besonders interessant, da sie oft ohne gro√üen eigenen finanziellen Aufwand genutzt werden k√∂nnen und einen fr√ºhen Einstieg in regelm√§√üiges Sparen erm√∂glichen. Wichtig ist dabei, sich fr√ºhzeitig zu informieren, da viele Berufseinsteiger diese M√∂glichkeit nicht kennen und dadurch finanzielle Vorteile ungenutzt bleiben."
    },

  ];

  fixedExplain.forEach(item => {

    const box = document.createElement("div");
    box.className = "faqBody";

    const h = document.createElement("h3");
    h.textContent = item.title;

    const p = document.createElement("p");
    p.textContent = item.text;

    box.appendChild(h);
    box.appendChild(p);

    root.appendChild(box);

  });

}


    // -----------------------------
    // Submit survey
    // -----------------------------
    $("#surveyForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const form = e.target;
      const fd = new FormData(form);

      const payload = {
        ts: new Date().toISOString(),
        ageGroup: fd.get("ageGroup") || "",
        status: fd.get("status") || "",
        source: fd.get("source") || "",
        goal: fd.get("goal") || "",
        bausparen_interest: fd.get("bausparen_interest") || "",
        bausparen_barrier: fd.get("bausparen_barrier") || "",
        insurance_priorities: fd.getAll("insurance_priorities"),
        contact_pref: fd.get("contact_pref") || "",
        openText: (fd.get("openText") || "").toString().trim()
      };

      const required = ["ageGroup","status","source","goal","bausparen_interest","bausparen_barrier","contact_pref"];
      const missing = required.filter(k => !payload[k]);
      if(missing.length){
        $("#surveyStatus").textContent = "Bitte f√ºlle alle Pflichtfelder aus.";
        toast("Pflichtfelder fehlen");
        return;
      }

      const all = readAll();
      all.push(payload);
      writeAll(all);
      setLastAnswer(payload);

      $("#surveyStatus").textContent = "Danke! Weiter zum Q&A ‚Ä¶";
      toast("Gespeichert ‚úÖ");

      unlockNextTabs();
      renderQna(payload);
      renderExplain(payload);
      updateResultsUI();
      updateOverviewKpis();

      if(isQRMode()){
        setQRStep(2);
      }
      showTab("qna");
      form.reset();
    });

    // admin demo fill
    const demoBtn = $("#fillDemo");
    if(demoBtn){
      demoBtn.addEventListener("click", ()=>{
        $("#ageGroup").value = "19-22";
        $("#status").value = "student";
        $$("input[name='goal']").find(x=>x.value==="wohnen").checked = true;
        $$("input[name='bausparen_interest']").find(x=>x.value==="unsicher").checked = true;
        $$("input[name='bausparen_barrier']").find(x=>x.value==="wissen").checked = true;
        const boxes = $$("input[type='checkbox'][name='insurance_priorities']");
        boxes.forEach(b=>b.checked=false);
        boxes.find(b=>b.value==="haftpflicht").checked = true;
        boxes.find(b=>b.value==="reise").checked = true;
        $$("input[name='contact_pref']").find(x=>x.value==="faq").checked = true;
        $("#openText").value = "Was ist der Unterschied zwischen Bausparen und alternativen Sparformen?";
        toast("Demo ausgef√ºllt ‚Äì jetzt absenden");
      });
    }

    // Q&A -> Explain
    $("#toExplain").addEventListener("click", ()=>{
      const last = getLastAnswer();
      if(!last){
        toast("Bitte zuerst die Umfrage ausf√ºllen.");
        showTab("survey");
        return;
      }
      renderExplain(last);
      unlockNextTabs();
      if(isQRMode()) setQRStep(3);
      showTab("explain");
    });

    // Admin navigation buttons
    $("#adminJumpSurvey").addEventListener("click", ()=>showTab("survey"));
    $("#adminJumpResults").addEventListener("click", ()=>showTab("results"));
    $("#backToSurvey").addEventListener("click", ()=>showTab("survey"));
    $("#backToQna").addEventListener("click", ()=>{
      const last = getLastAnswer();
      if(last){ renderQna(last); }
      showTab("qna");
      if(isQRMode()) setQRStep(2);
    });
    $("#toResults").addEventListener("click", ()=>showTab("results"));

    $("#adminToOverview").addEventListener("click", ()=>showTab("overview"));
    $("#adminToSurvey").addEventListener("click", ()=>showTab("survey"));

    // QR restart button
    $("#qrRestart").addEventListener("click", ()=>{
      // restart flow without deleting data
      setQRStep(1);
      showTab("survey");
      document.getElementById("surveyForm").scrollIntoView({behavior:"smooth", block:"start"});
    });

    // Reset
    $("#resetAll").addEventListener("click", ()=>{
      localStorage.removeItem(STORE_ANSWERS);
      localStorage.removeItem(STORE_LAST);
      $("#surveyStatus").textContent = "Zur√ºckgesetzt. Du kannst neu starten.";
      $("#exportStatus").textContent = "";
      $("#qnaTab").disabled = true;
      $("#explainTab").disabled = true;
      updateResultsUI();
      updateOverviewKpis();
      toast("Zur√ºckgesetzt");
      showTab(isQRMode() ? "survey" : "overview");
      if(isQRMode()) setQRStep(1);
    });

    // Results UI (admin)
    function updateResultsUI(){
      const all = readAll();
      const rCount = $("#rCount"); if(rCount) rCount.textContent = String(all.length);
      const rB = $("#rBausparen"); if(rB) rB.textContent = freqTop(all.map(x=>x.bausparen_interest));
      const rI = $("#rInsurance"); if(rI) rI.textContent = freqTop(all.map(x=>x.insurance_priorities));
      const box = $("#exportBox");
      if(box){
        box.value = JSON.stringify({ exportedAt: new Date().toISOString(), count: all.length, answers: all }, null, 2);
      }
    }

    function updateOverviewKpis(){
      const all = readAll();
      const k1 = $("#kpiCount"); if(k1) k1.textContent = String(all.length);
      const k2 = $("#kpiTopBausparen"); if(k2) k2.textContent = freqTop(all.map(x=>x.bausparen_interest));
      const k3 = $("#kpiTopInsurance"); if(k3) k3.textContent = freqTop(all.map(x=>x.insurance_priorities));
    }

    updateResultsUI();
    updateOverviewKpis();

    // Export actions
    const copyBtn = $("#copyJson");
    if(copyBtn){
      copyBtn.addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText($("#exportBox").value);
          $("#exportStatus").textContent = "JSON wurde kopiert.";
          toast("Kopiert üìã");
        }catch{
          $("#exportStatus").textContent = "Kopieren nicht m√∂glich (Browser-Einstellungen).";
          toast("Kopieren fehlgeschlagen");
        }
      });
    }

    const dlBtn = $("#downloadJson");
    if(dlBtn){
      dlBtn.addEventListener("click", ()=>{
        safeDownload("debeka-umfrage-export.json", $("#exportBox").value);
        $("#exportStatus").textContent = "Download gestartet.";
        toast("Download ‚¨áÔ∏è");
      });
    }

    // Boot
    function boot(){
      const baseUrl = location.href.split("#")[0].split("?")[0];
      const qrUrl = baseUrl + "#qr";
      $("#qrLinkBox").textContent = qrUrl;
      $("#qrLinkInline").textContent = qrUrl;
      $("#qrLinkRepeat").textContent = qrUrl;

      $("#today").textContent = new Date().toLocaleDateString("de-DE", { year:"numeric", month:"long", day:"numeric" });

      const qr = isQRMode();
      if(qr){
        document.body.classList.add("qr-mode");
        $("#qrBanner").style.display = "block";
        // QR flow always starts at survey
        showTab("survey");
        setQRStep(1);
        toast("QR-Modus aktiv ‚úÖ");

        // If there is a last answer (same device), allow jumping to Q&A/Explain
        const last = getLastAnswer();
        if(last){
          unlockNextTabs();
          renderQna(last);
          renderExplain(last);
          // If user refreshes in qr mode after survey, keep them at survey (step 1) to re-answer
          // They will progress after submit again.
        }
      }else{
        // admin mode
        const last = getLastAnswer();
        if(last){
          unlockNextTabs();
          renderQna(last);
          renderExplain(last);
        }
        showTab("overview");
      }
    }
    boot();
    function applyQrMode() {
  const isQr = (location.hash || "").toLowerCase().includes("qr");
    }

  </script>

  <!-- dein kompletter Website Inhalt -->

  <!-- Firebase Script HIER rein -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


    const firebaseConfig = {
      apiKey: "AIzaSyAFFwh67DFW4b3aKwPRlit7GRvH0bKlDG8",
      authDomain: "debeka-umfrage.firebaseapp.com",
      projectId: "debeka-umfrage",
      storageBucket: "debeka-umfrage.firebasestorage.app",
      messagingSenderId: "295363329740",
      appId: "1:295363329740:web:fd2e3f6ee264bb9a208c69"
    };

    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);
    // ===== Survey -> Firestore speichern =====
window.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("surveyForm");
  if (!form) {
    console.error("‚ùå surveyForm nicht gefunden. Pr√ºfe id='surveyForm' im HTML.");
    return;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const data = {};
    for (const [k, v] of formData.entries()) {
      if (data[k]) data[k] = Array.isArray(data[k]) ? [...data[k], v] : [data[k], v];
      else data[k] = v;
    }

    // Key aus deinem Projekt (anpassen falls anders!)
    const KEY = "debeka_answers_v3";

    let answersAll = [];
    try {
      answersAll = JSON.parse(localStorage.getItem(KEY) || "[]");
    } catch {
      answersAll = [];
    }

    answersAll.push({ ...data, _ts: Date.now() });

    // localStorage aktualisieren (damit Admin-View es wie gewohnt sieht)
    localStorage.setItem(KEY, JSON.stringify(answersAll));

    // Firestore speichern
    try {
      await addDoc(collection(window.db, "responses"), {
        answers: data,
        createdAt: serverTimestamp(),
        page: location.href,
        ua: navigator.userAgent
      });

      console.log("‚úÖ Firestore + local gespeichert", data);
      alert("Gespeichert ‚úÖ");
    } catch (err) {
      console.error("‚ùå Firestore Fehler:", err);
      alert("Speichern fehlgeschlagen (Cloud). √ñffne die Konsole f√ºr Details.");
    }
  });
});



  </script>



</body>
</html>